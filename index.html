<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ®2048</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
<script>
  if (!window.supabase) {
    document.write('<script src="https://unpkg.com/@supabase/supabase-js@2.39.7"><\/script>');
  }
</script>

<!-- â‘¡ ç´§è·Ÿç€ï¼Œç«‹åˆ»æ£€æŸ¥æœ‰æ²¡æœ‰åŠ è½½æˆåŠŸ -->
<script>
if (!window.supabase) {
  alert("Supabase SDK åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°æˆ–æ£€æŸ¥ç½‘ç»œ");
}
</script>

<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  color:#e0e0e0;
  font-family:monospace;
  display:flex;
  justify-content:center;
  padding:40px 0;
  overflow-x: hidden;

  background-color:#1e1e1e;
  background-image:
    repeating-linear-gradient(
      45deg,
      rgba(46,204,113,0.12) 0px,
      rgba(46,204,113,0.12) 1px,
      transparent 1px,
      transparent 24px
    ),
    repeating-linear-gradient(
      -45deg,
      rgba(231,76,60,0.08) 0px,
      rgba(231,76,60,0.08) 1px,
      transparent 1px,
      transparent 24px
    );
}

.game {
  background: #2b2b2b;      /* æ¸¸æˆç›’å­çš„èƒŒæ™¯é¢œè‰²ï¼ˆæ·±ç°è‰²ï¼‰ */
  padding: 14px;            /* ç›’å­çš„å†…è¾¹è·ï¼ˆå†…å®¹è·ç¦»è¾¹ç¼˜çš„é—´éš™ï¼‰ */
  border-radius: 8px;       /* ç›’å­å››ä¸ªè§’çš„åœ†è§’å¼§åº¦ */
  width: 380px;             /* ç›’å­çš„æ€»å®½åº¦ï¼ˆä½ ç°åœ¨è°ƒæˆäº†400pxï¼‰ */
  /* ä»¥ä¸‹ä¸‰è¡Œå†³å®šäº†å†…éƒ¨å…ƒç´ ï¼ˆåˆ†æ•°ã€ç½‘æ ¼ã€æ’è¡Œæ¦œï¼‰å¦‚ä½•æ’åˆ— */
  display: flex;            /* å¼€å¯å¼¹æ€§å¸ƒå±€ */
  flex-direction: column;   /* è®©å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ—ï¼ˆä»ä¸Šå¾€ä¸‹æ’ï¼‰ */
  gap: 10px;                /* å†…éƒ¨å„ä¸ªç»„ä»¶ï¼ˆå¦‚ç½‘æ ¼å’ŒæŒ‰é’®ï¼‰ä¹‹é—´çš„å‚ç›´è·ç¦» */ 
  margin: 0 auto;           /* è®©æ•´ä¸ªæ¸¸æˆç›’å­åœ¨ç½‘é¡µé¡µé¢æ°´å¹³å±…ä¸­ */
}

.top {
  display: flex;                /* å¼€å¯å¼¹æ€§å¸ƒå±€ï¼Œè®©â€œå¾—åˆ†â€å’Œâ€œçŠ¶æ€â€èƒ½æ’åœ¨åŒä¸€è¡Œ */
  /* å·¦å³å¯¹é½ï¼šè®©â€œå¾—åˆ†â€é å·¦è¾¹ï¼Œè®©â€œGame Overæç¤ºâ€é å³è¾¹ï¼Œä¸­é—´ç•™å‡ºç©ºéš™ */
  justify-content: space-between; 
  font-size: 14px;              /* è¿™ä¸€è¡Œæ–‡å­—çš„å¤§å° */
}

.grid {
  display: grid;                /* å¼€å¯ç½‘æ ¼å¸ƒå±€æ¨¡å¼ */
  /* å®šä¹‰åˆ—æ•°ï¼šrepeat(4, 70px) è¡¨ç¤ºåˆ›å»º 4 åˆ—ï¼Œæ¯åˆ—å®½åº¦å›ºå®šä¸º 70px */
  /* å¦‚æœä½ è°ƒå¤§äº† .cell çš„å®½åº¦ï¼Œè¿™é‡Œå¿…é¡»åŒæ­¥æŠŠ 70px æ”¹æ‰ */
  grid-template-columns: repeat(4, 82px); 
  grid-template-rows: repeat(4, 82px); 
  gap: 5px;                     /* æ–¹å—ä¸æ–¹å—ä¹‹é—´çš„ç¼éš™è·ç¦» */
  background: #555;             /* æ•´ä¸ªç½‘æ ¼åº•ç›˜çš„èƒŒæ™¯é¢œè‰²ï¼ˆé€šå¸¸æ¯”æ–¹å—æ·±ï¼‰ */
  padding: 5px;                 /* åº•ç›˜è¾¹ç¼˜ä¸å†…éƒ¨æ–¹å—ä¹‹é—´çš„è·ç¦» */
  border-radius: 6px;           /* åº•ç›˜å››ä¸ªè§’çš„åœ†è§’å¼§åº¦ */
  justify-content: center;      /* è®©æ‰€æœ‰çš„æ–¹å—åœ¨åº•ç›˜å†…æ°´å¹³å±…ä¸­ */
  touch-action: none;           /* ç¦ç”¨æµè§ˆå™¨é»˜è®¤çš„è§¦æ‘¸æ»šåŠ¨ï¼ˆé˜²æ­¢æ‰‹æœºç©æ¸¸æˆæ—¶é¡µé¢ä¹±è·³ï¼‰ */
  /* ç¡®ä¿å‚ç›´æ–¹å‘ä¹Ÿæ˜¯æ­£æ–¹å½¢ */
}

.cell {
  background: #777;           /* æ–¹å—çš„èƒŒæ™¯é¢œè‰²ï¼ˆç©ºæ–¹å—æ—¶çš„ç°è‰²ï¼‰ */
  height: 82px;               /* æ–¹å—çš„é«˜åº¦ */
  width: 82px;                /* æ–¹å—çš„å®½åº¦ï¼ˆå®½é«˜ä¸€è‡´å³ä¸ºæ­£æ–¹å½¢ï¼‰ */
  /* ä»¥ä¸‹ä¸‰è¡Œç”¨äºè®©æ•°å­—åœ¨æ–¹å—é‡Œæ°´å¹³ã€å‚ç›´ç»å¯¹å±…ä¸­ */
  display: flex;              /* ä½¿ç”¨å¼¹æ€§ç›’å­å¸ƒå±€ */
  align-items: center;        /* æ•°å­—å‚ç›´å±…ä¸­ */
  justify-content: center;    /* æ•°å­—æ°´å¹³å±…ä¸­ */
  font-size: 30px;            /* æ•°å­—çš„å¤§å° */
  font-weight: bold;          /* æ•°å­—åŠ ç²— */
  border-radius: 4px;         /* æ–¹å—å››ä¸ªè§’çš„åœ†è§’å¼§åº¦ */
  /* ä¸‹é¢è¿™ä¸€è¡Œè´Ÿè´£æ–¹å—ç§»åŠ¨æˆ–åˆå¹¶æ—¶çš„å¹³æ»‘åŠ¨ç”»æ•ˆæœ */
  transition: transform 0.12s ease, background-color 0.15s ease;
}

/* ğŸ¨ é«˜çº§æ–¹å—é…è‰² */

.v2    { background:#e74c3c; color:#fff; }  /* æ•°å­—2ï¼šçº¢è‰²èƒŒæ™¯ï¼Œç™½è‰²å­— */
.v4    { background:#27ae60; color:#fff; }  /* æ•°å­—4ï¼šç»¿è‰²èƒŒæ™¯ï¼Œç™½è‰²å­— */
.v8    { background:#f1c40f; color:#000; }  /* æ•°å­—8ï¼šé»„è‰²èƒŒæ™¯ï¼Œé»‘è‰²å­—ï¼ˆé»„è‰²èƒŒæ™¯é…é»‘å­—æ›´æ¸…æ™°ï¼‰ */
.v16   { background:#e67e22; color:#fff; }  /* æ•°å­—16ï¼šæ©™è‰²èƒŒæ™¯ */
.v32   { background:#d35400; color:#fff; }  /* æ•°å­—32ï¼šæ·±æ©™è‰²èƒŒæ™¯ */
.v64   { background:#c0392b; color:#fff; }  /* æ•°å­—64ï¼šæš—çº¢è‰²èƒŒæ™¯ */

/* ä»128å¼€å§‹ï¼Œæ–¹å—å¢åŠ äº† box-shadowï¼ˆå¤–å‘å…‰/é˜´å½±ï¼‰æ•ˆæœï¼Œè®©é«˜çº§æ–¹å—çœ‹èµ·æ¥åœ¨â€œå‘å…‰â€ */
.v128  { background:#1abc9c; color:#fff; box-shadow: 0 0 10px #1abc9c; }
.v256  { background:#3498db; color:#fff; box-shadow: 0 0 12px #3498db; }
.v512  { background:#9b59b6; color:#fff; box-shadow: 0 0 15px #9b59b6; }
.v1024 { background:#f39c12; color:#fff; box-shadow: 0 0 20px #f39c12; font-size: 20px; }

/* å¼ºçƒˆçš„è§å…‰é’è‰²å‘å…‰æ•ˆæœ */
.v2048 { 
  background: #111; 
  color: #00ffcc; 
  border: 2px solid #00ffcc; 
  box-shadow: 0 0 20px #00ffcc; 
  font-size: 20px;
}

/* 4096: äº®ç²‰è‰²ï¼Œå¸¦å¼ºå…‰ */
.v4096 { 
  background: #ff00de; 
  color: #fff; 
  box-shadow: 0 0 25px #ff00de; 
  font-size: 20px;
}

/* 8192: æ·±ç´«è‰²ï¼Œå¸¦æœ‰éœ“è™¹è¾¹æ¡† */
.v8192 { 
  background: #6a0dad; 
  color: #fff; 
  border: 2px solid #e0b0ff;
  box-shadow: 0 0 30px #6a0dad; 
  font-size: 20px;
}

/* 16384: çº¯ç™½è‰²èƒŒæ™¯ï¼Œé»‘è‰²æ•°å­—ï¼ˆæç®€è‡´ç›²å…‰ï¼‰ */
.v16384 { 
  background: #ffffff; 
  color: #000; 
  box-shadow: 0 0 40px #ffffff; 
  font-size: 16px;
}

/* 32768: åŠ¨æ€é‡‘é»‘è‰² */
.v32768 { 
  background: #000; 
  color: #ffd700; 
  border: 3px double #ffd700;
  box-shadow: 0 0 50px #ffd700; 
  font-size: 16px;
}

button {
  background: #444;      /* æŒ‰é’®çš„èƒŒæ™¯é¢œè‰²ï¼ˆæ·±ç°è‰²ï¼‰ */
  color: #fff;           /* æŒ‰é’®å†…æ–‡å­—çš„é¢œè‰²ï¼ˆç™½è‰²ï¼‰ */
  border: none;          /* å»æ‰æŒ‰é’®é»˜è®¤çš„è¾¹æ¡†ï¼ˆè®©å®ƒçœ‹èµ·æ¥æ›´æ‰å¹³ã€ç°ä»£ï¼‰ */
  padding: 8px;          /* æŒ‰é’®çš„å†…è¾¹è·ï¼ˆæ–‡å­—åˆ°æŒ‰é’®è¾¹ç¼˜çš„è·ç¦»ï¼Œå†³å®šæŒ‰é’®çš„å¤§å°ï¼‰ */
  border-radius: 4px;    /* æŒ‰é’®å››ä¸ªè§’çš„åœ†è§’å¼§åº¦ */
  cursor: pointer;       /* é¼ æ ‡æ‚¬åœåœ¨æŒ‰é’®ä¸Šæ—¶ï¼Œå…‰æ ‡å˜æˆâ€œå°æ‰‹â€å½¢çŠ¶ï¼ˆæç¤ºå¯ä»¥ç‚¹å‡»ï¼‰ */
}

/* æ’è¡Œæ¦œ */
.rank{
  background:#1f1f1f;
  border-radius:6px;
  padding:8px;
  font-size:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
  min-height: 100px;
  transition: opacity 0.3s;
}

.rank-title { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  font-weight: bold; 
  border-bottom: 1px solid #444; 
  padding-bottom: 4px; 
}

.refresh-btn {
  background: #333;
  color: #fff;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 10px;
}

.rank-header, .rank-row { 
  display: grid;                /* å¼€å¯ç½‘æ ¼å¸ƒå±€ï¼Œè®©åºå·ã€åå­—ã€åˆ†æ•°ã€æ—¶é—´æ•´é½å¯¹é½ */
  
  /* æ ¸å¿ƒè®¾ç½®ï¼šå®šä¹‰å››åˆ—çš„å®½åº¦åˆ†é… */
  /* 30px: ç¬¬ä¸€åˆ—ï¼ˆåºå· #ï¼‰å›ºå®šå®½åº¦ */
  /* 1fr:  ç¬¬äºŒåˆ—ï¼ˆåå­—ï¼‰å ç”¨å‰©ä½™çš„æ‰€æœ‰ç©ºé—´ï¼ˆè‡ªé€‚åº”å®½åº¦ï¼‰ */
  /* 50px: ç¬¬ä¸‰åˆ—ï¼ˆåˆ†æ•°ï¼‰å›ºå®šå®½åº¦ */
  /* 110px:ç¬¬å››åˆ—ï¼ˆæ—¶é—´ï¼‰å›ºå®šå®½åº¦ï¼Œç¡®ä¿ YYYY-MM-DD HH:MM:SS ä¸æ¢è¡Œ */
  grid-template-columns: 25px 110px 50px 110px; 
  
  gap: 4px;                     /* æ¯ä¸€åˆ—ä¹‹é—´çš„æ°´å¹³é—´éš™ */
  align-items: center;          /* è®©è¿™ä¸€è¡Œé‡Œçš„æ‰€æœ‰å†…å®¹åœ¨å‚ç›´æ–¹å‘ä¸Šå±…ä¸­å¯¹é½ */
}

.rank-index { text-align: right; color: #fff; }
.rank-header { color:#aaa; }
.rank-list { max-height:160px; overflow-y:auto; overflow-x:hidden; }
.rank-name { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.rank-score { text-align: left; }

.rank-time { 
  text-align: right;    /* æ–‡å­—å‘å³å¯¹é½ï¼Œè®©æ—¶é—´æ•°å­—çš„æœ«å°¾æ•´é½æ’åˆ— */
  opacity: 0.8;         /* é€æ˜åº¦è®¾ä¸º 0.8ï¼ˆç¨å¾®å˜æ·¡ï¼‰ï¼Œä½¿å…¶è§†è§‰æƒé‡ä½äºåå­—å’Œåˆ†æ•° */
  
  font-size: 11px;      /* å­—ä½“å¤§å°ã€‚æ—¶é—´å­—ç¬¦å¤šï¼Œé€‚åˆç”¨è¾ƒå°çš„å­—å·é˜²æ­¢æ‹¥æŒ¤ */
  padding-right: 2px;   /* å³ä¾§å†…è¾¹è·ï¼Œé˜²æ­¢æ—¶é—´æ–‡å­—ç´§è´´ç€æ’è¡Œæ¦œçš„æœ€å³è¾¹ç¼˜ */
  
  /* å…³é”®å±æ€§ï¼šå¼ºåˆ¶æ–‡å­—åœ¨åŒä¸€è¡Œæ˜¾ç¤ºï¼Œç»å¯¹ä¸å…è®¸å› ä¸ºç©ºé—´ä¸è¶³è€ŒæŠ˜è¡Œ */
  white-space: nowrap;  
  
  line-height: 1.5;     /* è¡Œé«˜ã€‚å¢åŠ ä¸€ç‚¹è¡Œé—´è·ï¼Œè®©ä¸Šä¸‹è¡Œçš„æ—¶é—´çœ‹èµ·æ¥ä¸é‚£ä¹ˆæ‹¥æŒ¤ */
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal-box{
  background:#2b2b2b;
  padding:16px;
  border-radius:8px;
  width:320px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.hint { text-align: center; font-size: 12px; color: #fff; letter-spacing: 2px; user-select: none; }

@keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
.cell.moved{ animation: pop 0.18s ease; }
@keyframes spawn { 0% { transform: scale(0.3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
.cell.spawn{ animation: spawn 0.2s ease-out; }
</style>

</head>

<body>
<div class="game">
  <div class="top">
    <div>å¾—åˆ†ï¼š<span id="score">0</span></div>
    <div id="status"></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="hint">â¬†ï¸ â¬…ï¸ â¬‡ï¸ â¡ï¸ ç§»åŠ¨æ–¹å—</div>

  <button onclick="restart()">é‡æ–°å¼€å§‹</button>

  <div class="rank" id="rank">æ­£åœ¨è¯»å–æ’è¡Œæ¦œâ€¦</div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <div style="text-align:center; font-weight:bold;">Game over!</div>
    <div>ä½ çš„å¾—åˆ†æ˜¯ï¼š<span id="finalScore"></span></div>
    <div style="font-size:13px; opacity:0.8; margin-bottom:4px;">è¯·è¾“å…¥æ˜µç§°...ç»„ç»‡ä¸Šä¼šè®°ä½ä½ çš„!</div>
    <input id="playerName" placeholder="åŒ¿åç©å®¶" maxlength="16" style="width:100%; padding:6px; border-radius:4px; border:none;">
    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
      <button onclick="submitScore()" id="subBtn">è®°å½•å¾—åˆ†</button>
      <button onclick="closeModal()">æ¦‚ä¸ç•™å</button>
    </div>
  </div>
</div>

<script>
const supabaseUrl = "https://hivlyphuvzvwnobnoqdl.supabase.co";
const supabaseKey = "sb_publishable_B3tNHsrkG6U2wu9jW64smA_XtfaDNM0";
const db = supabase.createClient(supabaseUrl, supabaseKey);

let grid = Array(16).fill(0);
let score = 0;
let gameOver = false;
let spawnedIndex = null;
let lastGrid = Array(16).fill(0);

const gridEl = document.getElementById("grid");
const scoreEl = document.getElementById("score");
const statusEl = document.getElementById("status");
const rankEl = document.getElementById("rank");

function draw(){
  gridEl.innerHTML="";
  grid.forEach((v,i)=>{
    let d = document.createElement("div");
    d.className = "cell" + (v ? " v"+v : "");
    if(v !== lastGrid[i]) d.classList.add("moved");
    if(i === spawnedIndex) d.classList.add("spawn");
    d.textContent = v || "";
    gridEl.appendChild(d);
  });
  lastGrid = [...grid];
  spawnedIndex = null;
  scoreEl.textContent = score;
}

function randomAdd(){
  let e = grid.map((v,i)=>v===0?i:null).filter(v=>v!==null);
  if(!e.length) return;
  spawnedIndex = e[Math.floor(Math.random()*e.length)];
  grid[spawnedIndex] = Math.random() < 0.9 ? 2 : 4;
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]===arr[i+1]){
      arr[i]*=2;
      score+=arr[i];
      arr[i+1]=0;
    }
  }
  arr=arr.filter(v=>v);
  while(arr.length<4)arr.push(0);
  return arr;
}

function move(dir){
  if(gameOver) return;
  let moved=false;
  let g=[...grid];
  const idx=(i,j)=>{
    if(dir==="L")return i*4+j;
    if(dir==="R")return i*4+3-j;
    if(dir==="U")return j*4+i;
    return 12-j*4+i;
  };
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++)line.push(g[idx(i,j)]);
    let s=slide(line);
    for(let j=0;j<4;j++){
      let k=idx(i,j);
      if(grid[k]!==s[j]){grid[k]=s[j];moved=true;}
    }
  }
  if(moved){
    randomAdd();
    draw();
    checkOver();
  }
}

function checkOver(){
  if(grid.includes(0))return;
  for(let i=0;i<16;i++){
    if(i%4<3 && grid[i]===grid[i+1])return;
    if(i<12 && grid[i]===grid[i+4])return;
  }
  gameOver = true;
  statusEl.textContent = "Game over!â˜ ï¸â˜ ï¸â˜ ï¸";
  openModal();
}

function formatTime(t){
  const utc = new Date(t).getTime();
  const beijing = new Date(utc + 8 * 60 * 60 * 1000);
  const Y = beijing.getFullYear();
  const M = String(beijing.getMonth() + 1).padStart(2, "0");
  const D = String(beijing.getDate()).padStart(2, "0");
  const h = String(beijing.getHours()).padStart(2, "0");
  const m = String(beijing.getMinutes()).padStart(2, "0");
  const s = String(beijing.getSeconds()).padStart(2, "0");
  
  // å°†è¿™é‡Œçš„ <br> æ›¿æ¢ä¸ºç©ºæ ¼
  return `${Y}-${M}-${D} ${h}:${m}:${s}`; 
}

// ğŸŒ ç§»æ¤ï¼šç½‘ç»œä¼˜åŒ–åçš„åŠ è½½å‡½æ•°
async function loadRank(){
  rankEl.style.opacity = "0.6";
  try {
    let { data, error } = await db.from("scores").select("*").order("score",{ ascending:false }).limit(50);
    if(error) throw error; // æŠ›å‡ºé”™è¯¯è¿›å…¥ catch

    rankEl.innerHTML=`
      <div class="rank-title">
        <button class="refresh-btn" onclick="loadRank()">åˆ·æ–°</button>
        <span>ğŸŒ æ’è¡Œæ¦œ â­</span>
        <div style="width:30px"></div>
      </div>
      <div class="rank-header">
        <div class="rank-index">#</div>
        <div class="rank-name">ç©å®¶</div>
        <div class="rank-score">åˆ†æ•°</div>
        <div class="rank-time">æ—¶é—´</div>
      </div>
      <div class="rank-list">
        ${data.map((v,i)=>{
          let displayIndex = i===0 ? "ğŸ‘‘1" : i+1;
          let nameColor = i === 0 ? "#FFD700" : i === 1 ? "#C0C0C0" : i === 2 ? "#CD7F32" : "#e0e0e0";
          return `
            <div class="rank-row">
              <div class="rank-index">${displayIndex}</div>
              <div class="rank-name" style="color:${nameColor};" title="${v.name}">${v.name}</div>
              <div class="rank-score">${v.score}</div>
              <div class="rank-time">${formatTime(v.created_at)}</div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  } catch(e) {
    // ğŸŒ ç§»æ¤ï¼šé”™è¯¯å¤„ç†ç•Œé¢
    rankEl.innerHTML = `
      <div class="rank-title">
        <button class="refresh-btn" onclick="loadRank()">é‡è¯•</button>
        <span style="color:#ff6b6b;">åŒæ­¥å¤±è´¥ ğŸ“¡</span>
        <div style="width:30px"></div>
      </div>
      <div style="text-align:center; padding:15px; font-size:11px; opacity:0.6;">æ— æ³•è¿æ¥æ’è¡Œæ¦œï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚</div>
    `;
  }
  rankEl.style.opacity = "1";
}

document.addEventListener("keydown", e => {
  if (["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key)) e.preventDefault();
  if(e.key==="ArrowLeft") move("L");
  if(e.key==="ArrowRight") move("R");
  if(e.key==="ArrowUp") move("U");
  if(e.key==="ArrowDown") move("D");
});

let sx, sy;
gridEl.addEventListener("touchstart", e=>{
  sx = e.touches[0].clientX;
  sy = e.touches[0].clientY;
},{ passive:false });

gridEl.addEventListener("touchend", e=>{
  let dx = e.changedTouches[0].clientX - sx;
  let dy = e.changedTouches[0].clientY - sy;
  if(Math.abs(dx) > Math.abs(dy)){
    if(dx > 30) move("R");
    if(dx < -30) move("L");
  } else {
    if(dy > 30) move("D");
    if(dy < -30) move("U");
  }
},{ passive:false });

function restart(){
  grid.fill(0);
  score = 0;
  gameOver = false;
  statusEl.textContent = "";
  randomAdd();
  randomAdd();
  draw();
}

function openModal(){
  document.getElementById("finalScore").textContent = score;
  document.getElementById("modal").style.display = "flex";
}

async function submitScore(){
  const btn = document.getElementById("subBtn");
  let name = document.getElementById("playerName").value.trim() || "åŒ¿åç©å®¶";
  
  btn.disabled = true;
  btn.textContent = "è®°å½•ä¸­...";
  
  try {
    const { error } = await db.from("scores").insert({ name, score });
    if(error) throw error;
    document.getElementById("modal").style.display = "none";
    loadRank();
  } catch(e) {
    alert("åˆ†æ•°æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
  } finally {
    btn.disabled = false;
    btn.textContent = "è®°å½•å¾—åˆ†";
  }
}

function closeModal(){
  document.getElementById("modal").style.display = "none";
}

restart();
loadRank();
</script>
</body>
</html>
